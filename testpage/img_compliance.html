<!DOCTYPE html>
<html>
<head>
    <title>WHATWG 4.8.3 img Element - Alt Fallback Compliance Test</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 30px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .description { color: #555; margin-bottom: 10px; }
        .expected { color: #0066cc; font-style: italic; }
        code { background-color: #f5f5f5; padding: 2px 6px; }
    </style>
</head>
<body>
    <h1>WHATWG 4.8.3 img Element - Alt Fallback Compliance Test</h1>
    <p>Tests how the browser handles <code>&lt;img&gt;</code> elements when images cannot be loaded.
    Per WHATWG spec, the <code>alt</code> attribute provides fallback text that should be shown
    when the image is unavailable.</p>

    <h2>IDL: image.width / image.height getter/setter</h2>

    <h2>Test W1: width getter matches HTML attribute</h2>
    <div class="test">
        <p class="description">Image with <code>width="200"</code> and <code>height="150"</code> in HTML. JS reads <code>img.width</code> and <code>img.height</code>.</p>
        <p class="expected">Expected: width=200, height=150</p>
        <img id="w1" src="https://picsum.photos/200/150" width="200" height="150" alt="test image">
        <p id="w1-result">Reading...</p>
        <script>
            var el = document.getElementById("w1");
            document.getElementById("w1-result").textContent =
                "img.width=" + el.width + ", img.height=" + el.height;
        </script>
    </div>

    <h2>Test W2: width setter resizes the image</h2>
    <div class="test">
        <p class="description">Image starts at <code>width="100"</code>. JS sets <code>img.width = 300</code>. The rendered size should change.</p>
        <p class="expected">Expected: image visually widens; getter reports width=300</p>
        <img id="w2" src="https://picsum.photos/200/150" width="100" height="75" alt="resize test">
        <p id="w2-result">Waiting...</p>
        <script>
            var el2 = document.getElementById("w2");
            var before = el2.width;
            el2.width = 300;
            var after = el2.width;
            document.getElementById("w2-result").textContent =
                "Before: " + before + " → After: " + after + " (expected 100 → 300)";
        </script>
    </div>

    <h2>Test W3: getter returns 0 for unloaded image with no attributes</h2>
    <div class="test">
        <p class="description">Broken image with no <code>width</code> or <code>height</code> attributes. Getter should return 0 (not laid out, not loaded).</p>
        <p class="expected">Expected: width=0, height=0</p>
        <img id="w3" src="https://this-does-not-exist.example/img.png" alt="broken no dims">
        <p id="w3-result">Reading...</p>
        <script>
            var el3 = document.getElementById("w3");
            document.getElementById("w3-result").textContent =
                "img.width=" + el3.width + ", img.height=" + el3.height;
        </script>
    </div>

    <h2>Test W4: setter reflects back into getAttribute</h2>
    <div class="test">
        <p class="description">After <code>img.width = 250</code>, the HTML attribute should also update. <code>getAttribute("width")</code> should return <code>"250"</code>.</p>
        <p class="expected">Expected: getAttribute("width")="250"</p>
        <img id="w4" src="https://picsum.photos/100/100" width="100" height="100" alt="attr reflection test">
        <p id="w4-result">Reading...</p>
        <script>
            var el4 = document.getElementById("w4");
            el4.width = 250;
            document.getElementById("w4-result").textContent =
                'getAttribute("width")="' + el4.getAttribute("width") + '" (expected "250")';
        </script>
    </div>

    <h2>Test W5: negative value should throw RangeError</h2>
    <div class="test">
        <p class="description">Setting <code>img.width = -1</code> should throw a <code>RangeError</code> per spec (unsigned long IDL type).</p>
        <p class="expected">Expected: RangeError caught; width unchanged</p>
        <img id="w5" src="https://picsum.photos/100/100" width="100" height="100" alt="negative test">
        <p id="w5-result">Reading...</p>
        <script>
            var el5 = document.getElementById("w5");
            try {
                el5.width = -1;
                document.getElementById("w5-result").textContent = "No error thrown (non-compliant)";
            } catch (e) {
                document.getElementById("w5-result").textContent =
                    "Caught: " + e.name + " ✓";
            }
        </script>
    </div>

    <h2>Test W6: non-integer value is truncated</h2>
    <div class="test">
        <p class="description">Setting <code>img.width = 3.9</code>. IDL unsigned long truncates toward zero — result should be <code>3</code>, not <code>4</code>.</p>
        <p class="expected">Expected: img.width=3</p>
        <img id="w6" src="https://picsum.photos/100/100" width="100" height="100" alt="truncation test">
        <p id="w6-result">Reading...</p>
        <script>
            var el6 = document.getElementById("w6");
            el6.width = 3.9;
            document.getElementById("w6-result").textContent =
                "img.width=" + el6.width + " (expected 3)";
        </script>
    </div>

    <h2>IDL: image.naturalWidth / image.naturalHeight</h2>

    <h2>Test N1: natural dimensions of loaded image</h2>
    <div class="test">
        <p class="description">Reads <code>img.naturalWidth</code> and <code>img.naturalHeight</code> from a local fixture image.</p>
        <p class="expected">Expected: naturalWidth=544, naturalHeight=184 (for sample-bg.png)</p>
        <img id="n1" src="sample-bg.png" alt="natural size fixture">
        <p id="n1-result">Reading...</p>
        <script>
            var n1 = document.getElementById("n1");
            document.getElementById("n1-result").textContent =
                "img.naturalWidth=" + n1.naturalWidth + ", img.naturalHeight=" + n1.naturalHeight;
        </script>
    </div>

    <h2>Test N2: rendered size does not change natural dimensions</h2>
    <div class="test">
        <p class="description">Image is rendered at <code>272x92</code>, but natural dimensions should remain the source dimensions.</p>
        <p class="expected">Expected: width=272, height=92, naturalWidth=544, naturalHeight=184</p>
        <img id="n2" src="sample-bg.png" width="272" height="92" alt="scaled natural size fixture">
        <p id="n2-result">Reading...</p>
        <script>
            var n2 = document.getElementById("n2");
            document.getElementById("n2-result").textContent =
                "img.width=" + n2.width +
                ", img.height=" + n2.height +
                ", img.naturalWidth=" + n2.naturalWidth +
                ", img.naturalHeight=" + n2.naturalHeight;
        </script>
    </div>

    <h2>Test N3: broken image reports zero natural dimensions</h2>
    <div class="test">
        <p class="description">Broken image with no decodable resource should report <code>0</code> natural dimensions.</p>
        <p class="expected">Expected: naturalWidth=0, naturalHeight=0</p>
        <img id="n3" src="missing-natural-size.png" alt="broken natural size test">
        <p id="n3-result">Reading...</p>
        <script>
            var n3 = document.getElementById("n3");
            document.getElementById("n3-result").textContent =
                "img.naturalWidth=" + n3.naturalWidth + ", img.naturalHeight=" + n3.naturalHeight;
        </script>
    </div>

    <h2>IDL: image.complete</h2>

    <h2>Test C1: no src is complete</h2>
    <div class="test">
        <p class="description">Image element with no <code>src</code> should report <code>complete=true</code>.</p>
        <p class="expected">Expected: complete=true</p>
        <img id="c1" alt="no source complete test">
        <p id="c1-result">Reading...</p>
        <script>
            var c1 = document.getElementById("c1");
            document.getElementById("c1-result").textContent =
                "img.complete=" + c1.complete;
        </script>
    </div>

    <h2>Test C2: broken image reaches terminal complete state</h2>
    <div class="test">
        <p class="description">Broken image should eventually report <code>complete=true</code> (terminal state after load failure).</p>
        <p class="expected">Expected: delayed complete=true</p>
        <img id="c2" src="missing-complete.png" alt="broken complete test">
        <p id="c2-result">Waiting...</p>
        <script>
            var c2 = document.getElementById("c2");
            setTimeout(function() {
                document.getElementById("c2-result").textContent =
                    "img.complete(after 500ms)=" + c2.complete;
            }, 500);
        </script>
    </div>

    <h2>Test C3: valid image transitions to complete</h2>
    <div class="test">
        <p class="description">Valid image may start as incomplete while loading, then should report <code>complete=true</code>.</p>
        <p class="expected">Expected: delayed complete=true</p>
        <img id="c3" src="sample-bg.png" alt="valid complete test">
        <p id="c3-result">Reading...</p>
        <script>
            var c3 = document.getElementById("c3");
            var c3Immediate = c3.complete;
            setTimeout(function() {
                document.getElementById("c3-result").textContent =
                    "img.complete(immediate)=" + c3Immediate + ", img.complete(after 500ms)=" + c3.complete;
            }, 500);
        </script>
    </div>

    <h1>Alt Fallback Tests (WHATWG 4.8.3)</h1>

    <h2>Test 1: Broken URL with alt text</h2>
    <div class="test">
        <p class="description">Image with a broken src URL and a meaningful alt attribute.</p>
        <p class="expected">Expected: Shows alt text "[A majestic mountain landscape]" or similar indicator instead of a blank space.</p>
        <img src="https://this-domain-does-not-exist-xyz.example/photo.jpg" alt="A majestic mountain landscape" width="300" height="200">
    </div>

    <h2>Test 2: Local missing file with alt text</h2>
    <div class="test">
        <p class="description">Image pointing to a local file that does not exist.</p>
        <p class="expected">Expected: Shows alt text "Company logo" as fallback.</p>
        <img src="missing-image.png" alt="Company logo" width="200" height="80">
    </div>

    <h2>Test 3: Empty alt attribute (decorative image)</h2>
    <div class="test">
        <p class="description">Image with <code>alt=""</code> — marks the image as purely decorative. Per WHATWG spec, no fallback text is needed.</p>
        <p class="expected">Expected: Nothing shown (or a blank placeholder). No alt text because it is decorative.</p>
        <img src="missing-decorative.png" alt="" width="100" height="100">
        <p>(Decorative image above — blank is correct behaviour)</p>
    </div>

    <h2>Test 4: Missing alt attribute entirely</h2>
    <div class="test">
        <p class="description">Image with no <code>alt</code> attribute at all. The spec says this means the image is not described — its purpose is unknown.</p>
        <p class="expected">Expected: A generic placeholder (e.g., "[image]") or blank, since no description was provided.</p>
        <img src="no-alt-image.png" width="150" height="100">
    </div>

    <h2>Test 5: Valid image (control case)</h2>
    <div class="test">
        <p class="description">A real image that should load successfully — the alt text should NOT be shown.</p>
        <p class="expected">Expected: The actual image is displayed; alt text is hidden.</p>
        <img src="https://picsum.photos/200/150" alt="A random placeholder image" width="200" height="150">
    </div>

    <h2>Test 6: Long alt text</h2>
    <div class="test">
        <p class="description">Image with a lengthy alt description, testing text wrapping in the fallback area.</p>
        <p class="expected">Expected: Fallback text wraps within the image's allocated width.</p>
        <img src="missing-chart.png" alt="Bar chart showing quarterly revenue growth from Q1 2023 to Q4 2024, with a peak in Q3 2024" width="400" height="250">
    </div>

    <h2>Test 7: Alt text with special characters</h2>
    <div class="test">
        <p class="description">Alt attribute containing HTML entities and special punctuation.</p>
        <p class="expected">Expected: Renders as plain text — "Caf&eacute; &amp; Bistro logo — Est. 1999".</p>
        <img src="missing-logo.png" alt="Café &amp; Bistro logo — Est. 1999" width="200" height="80">
    </div>

    <h2>Test 8: Image inside a link (clickable)</h2>
    <div class="test">
        <p class="description">A broken image wrapped in an anchor tag. The alt text should still be visible and the whole area should remain clickable.</p>
        <p class="expected">Expected: Alt text "Visit our homepage" shown as a fallback, and it acts as a link.</p>
        <a href="https://example.com">
            <img src="missing-banner.png" alt="Visit our homepage" width="300" height="60">
        </a>
    </div>

    <h2>Test 9: Image inside figure with figcaption</h2>
    <div class="test">
        <p class="description">Broken image inside a <code>&lt;figure&gt;</code>. Alt text and figcaption should both appear.</p>
        <p class="expected">Expected: Alt text shown where image would be, caption "Figure 1: Eiffel Tower at dusk" below.</p>
        <figure>
            <img src="missing-eiffel.jpg" alt="Eiffel Tower at dusk, Paris" width="300" height="200">
            <figcaption>Figure 1: Eiffel Tower at dusk</figcaption>
        </figure>
    </div>

    <h2>Test 10: Multiple broken images in a row</h2>
    <div class="test">
        <p class="description">Several consecutive broken images, each with distinct alt text.</p>
        <p class="expected">Expected: Each image shows its own alt text independently.</p>
        <img src="missing1.png" alt="Red apple" width="100" height="100">
        <img src="missing2.png" alt="Green pear" width="100" height="100">
        <img src="missing3.png" alt="Blue blueberry" width="100" height="100">
    </div>

    <h2>Test 11: Image with width and height of zero</h2>
    <div class="test">
        <p class="description">Edge case — image with zero dimensions. Even with alt text, nothing visible should appear.</p>
        <p class="expected">Expected: Nothing rendered (zero-size box).</p>
        <img src="missing-zero.png" alt="You should not see this" width="0" height="0">
        <p>(Zero-size image above — should be invisible)</p>
    </div>

    <h2>Test 12: Image with no dimensions specified</h2>
    <div class="test">
        <p class="description">Broken image with no <code>width</code> or <code>height</code> attributes. The browser must choose a default size for the fallback area.</p>
        <p class="expected">Expected: Fallback text shown in a default-sized placeholder box.</p>
        <img src="missing-nodims.png" alt="Photo with no dimensions given">
    </div>

</body>
</html>
